<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>垃圾校园网，我忍不了了 - zu1k</title><meta name=description content="校园网被限速了，受不了垃圾网速，动手搞了单线多拨网速叠加"><meta name=keywords content="多拨,校园网,带宽叠加,openwrt,lede,macvlan,ikuai,爱快,分流,负载均衡,策略路由,iptables,zu1k,zuik,zu1k.com,网络安全,思考,逆向"><meta name=author content="zu1k"><meta property="og:title" content="垃圾校园网，我忍不了了"><meta property="og:description" content="校园网被限速了，受不了垃圾网速，动手搞了单线多拨网速叠加"><meta property="og:type" content="article"><meta property="og:url" content="https://zu1k.com/posts/tutorials/campus-network-speed-overlay/"><meta property="og:image" content="https://zu1k.com/images/logo.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-11T17:11:00+08:00"><meta property="article:modified_time" content="2023-01-03T09:19:01+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zu1k.com/images/logo.jpg"><meta name=twitter:title content="垃圾校园网，我忍不了了"><meta name=twitter:description content="校园网被限速了，受不了垃圾网速，动手搞了单线多拨网速叠加"><meta name=application-name content="zu1k"><meta name=apple-mobile-web-app-title content="zu1k"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><meta itemprop=name content="垃圾校园网，我忍不了了"><meta itemprop=description content="校园网被限速了，受不了垃圾网速，动手搞了单线多拨网速叠加"><meta itemprop=datePublished content="2021-04-11T17:11:00+08:00"><meta itemprop=dateModified content="2023-01-03T09:19:01+08:00"><meta itemprop=wordCount content="3516"><meta itemprop=image content="https://zu1k.com/images/logo.jpg"><meta itemprop=keywords content="Linux,多拨,"><link rel="shortcut icon" type=image/x-icon href=../../../favicon.ico><link rel=icon type=image/png sizes=32x32 href=../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=../../../apple-touch-icon.png><link rel=mask-icon href=../../../apple-touch-icon.png color=#5bbad5><link rel=manifest href=../../../site.webmanifest><link rel=canonical href=https://zu1k.com/posts/tutorials/campus-network-speed-overlay/><link rel=prev href=https://zu1k.com/posts/thinking/knowledge-refining/><link rel=next href=https://zu1k.com/posts/thinking/fuck-involution/><link rel=stylesheet href=../../../lib/normalize/normalize.min.css><link rel=stylesheet href=../../../css/style.min.css><link rel=stylesheet href=../../../lib/icon/css/icon-embedded.css><script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js")})</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"垃圾校园网，我忍不了了","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/zu1k.com\/posts\/tutorials\/campus-network-speed-overlay\/"},"image":[{"@type":"ImageObject","url":"https:\/\/zu1k.com\/images\/logo.jpg","width":256,"height":256}],"genre":"posts","keywords":"Linux, 多拨","wordcount":3516,"url":"https:\/\/zu1k.com\/posts\/tutorials\/campus-network-speed-overlay\/","datePublished":"2021-04-11T17:11:00+08:00","dateModified":"2023-01-03T09:19:01+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"zu1k","logo":"https:\/\/zu1k.com\/images\/logo.jpg"},"author":{"@type":"Person","name":"zu1k"},"description":"校园网被限速了，受不了垃圾网速，动手搞了单线多拨网速叠加"}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=../../../ title=zu1k>zu1k</a></div><div class=menu><div class=menu-inner><a class=menu-item href=../../../posts/>文章 </a><a class=menu-item href=../../../categories/>分类 </a><a class=menu-item href=../../../tags/>标签 </a><a class=menu-item href=../../../projects/>项目 </a><a class=menu-item href=../../../links/>友链 </a><a class=menu-item href=../../../about/>关于 </a><a class=menu-item href=../../../index.xml title=RSS><i class=icon-rss></i> </a><a class=menu-item href=https://github.com/zu1k title=GitHub rel="noopener noreffer" target=_blank><i class=icon-github></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class=icon-search></i></a>
<a class="search-button search-clear" id=search-clear-desktop title=清空><i class=icon-cancel-circled></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class=icon-spin2></i></span>
</span><a class="menu-item theme-switch" title=切换主题><i class=icon-adjust></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=../../../ title=zu1k>zu1k</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class=icon-search></i></a>
<a class="search-button search-clear" id=search-clear-mobile title=清空><i class=icon-cancel-circled></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class=icon-spin2></i></span></div><a class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=../../../posts/ title>文章</a><a class=menu-item href=../../../categories/ title>分类</a><a class=menu-item href=../../../tags/ title>标签</a><a class=menu-item href=../../../projects/ title>项目</a><a class=menu-item href=../../../links/ title>友链</a><a class=menu-item href=../../../about/ title>关于</a><a class=menu-item href=../../../index.xml title=RSS><i class=icon-rss></i></a><a class=menu-item href=https://github.com/zu1k title=GitHub rel="noopener noreffer" target=_blank><i class=icon-github></i></a><a class="menu-item theme-switch" title=切换主题>
<i class=icon-adjust></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class=single-title>垃圾校园网，我忍不了了</h1><div class=post-meta><div class=post-meta-line>&nbsp;<span class=post-category>收录于 <a href=../../../categories/tutorial/><i class=icon-folder></i>教程</a></span></div><div class=post-meta-line><i class=icon-calendar></i>&nbsp;<time datetime=2021-04-11>2021-04-11</time>&nbsp;<i class=icon-pencil></i>&nbsp;约 3516 字&nbsp;
<i class=icon-clock></i>&nbsp;阅读 8 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon icon-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#linux下手工操作>Linux下手工操作</a><ul><li><a href=#利用macvlan获取多个ip>利用macvlan获取多个IP</a></li><li><a href=#进行联网认证>进行联网认证</a></li><li><a href=#进行路由级别的分流>进行路由级别的分流</a><ul><li><a href=#创建路由表>创建路由表</a></li><li><a href=#配置iptables>配置iptables</a></li><li><a href=#配置策略路由>配置策略路由</a></li><li><a href=#用作路由器>用作路由器</a></li></ul></li></ul></li><li><a href=#使用openwrtmwan3>使用OpenWrt+mwan3</a><ul><li><a href=#添加设备获取ip>添加设备，获取IP</a></li><li><a href=#配置mwan3分流>配置mwan3分流</a></li></ul></li><li><a href=#爱快分流很强大>爱快，分流很强大</a></li><li><a href=#新发现>新发现</a></li></ul></nav></div></div><div class=content id=content><p>记得大一刚入学时，免费的校园网是上下行对等的100Mbps带宽，虽然赶不上家里的速度，但是用起来还是比较舒服的</p><p>万万没想到，当别的学校都在忙着升级成千兆网络的时候，自己学校竟然来了个反向操作，30Mbps限速，真TMD鬼，不知道怎么想的</p><p>这垃圾校园网，我是忍不了了，考虑到每个人都能多个设备同时登录，肯定就有多拨的可能，那就搞起来！</p><h2 id=linux下手工操作>Linux下手工操作</h2><p>本着学习的态度，上来肯定要先在Linux下手动操作一遍（其实我是先用iKuai验证可行后，才尝试用Linux手工配的</p><p>我们的基本思路是：</p><ol><li>拿到多个IP</li><li>过了学校的联网认证</li><li>进行负载均衡</li></ol><p>以下所有操作都需要root权限</p><h3 id=利用macvlan获取多个ip>利用macvlan获取多个IP</h3><p>首先要创建多个虚拟网络接口，利用不同的Mac地址进行DHCP获取多个不同的IP地址</p><p>在Linux下，内核提供的macvlan就可以实现我们的需求，从Linux Kernel 3.9开始就支持了貌似，所以只要不是安装非常老的系统都是支持的</p><p>查看一下你的系统是否支持：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># modprobe macvlan</span>
</span></span><span class=line><span class=cl><span class=c1># lsmod | grep macvlan</span>
</span></span><span class=line><span class=cl>macvlan                <span class=m>24576</span>  <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>如果显示类似上面的内容就表示支持</p><p>添加一个macvlan类型的网络接口：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ip link add link &lt;physical-network-interface-name&gt; &lt;new-network-interface-name&gt; <span class=nb>type</span> macvlan
</span></span></code></pre></td></tr></table></div></div><p>例如，通过 <code>ip addr</code> 或者 <code>ifconfig</code> 查看到物理网卡名为 <code>eth0</code>，新网络接口名我们用 <code>vmac0</code> <code>vmac1</code> 这样的表示，命令如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ip link add link eth0 vmac0 <span class=nb>type</span> macvlan
</span></span><span class=line><span class=cl>ip link add link eth0 vmac1 <span class=nb>type</span> macvlan
</span></span></code></pre></td></tr></table></div></div><p>这样就创建了两个新的网络接口，依附于物理接口 <code>eth0</code>，两个新网络接口的mac地址是自动分配的，每一次新建都会随机生成。</p><p>如果想要手动指定mac地址，可以使用下面的命令:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ip link add link &lt;physical-network-interface-name&gt; &lt;new-network-interface-name&gt; address &lt;mac-address&gt; <span class=nb>type</span> macvlan
</span></span><span class=line><span class=cl>例如：
</span></span><span class=line><span class=cl>ip link add link eth0 vmac0 address 11:22:33:44:55:66 <span class=nb>type</span> macvlan
</span></span></code></pre></td></tr></table></div></div><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon icon-lightbulb"></i>技巧<i class="details-icon icon-angle-circled-right"></i></div><div class=details-content><div class=admonition-content>更加详细的命令通过 <code>ip link help</code> 和 <code>man ip link</code> 查看</div></div></div><p>经过上面这一步，就就可以通过 <code>ip link</code> 看到多了两个网络接口</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>4: vmac0@eth0: &lt;BROADCAST,MULTICAST&gt; mtu <span class=m>1500</span> qdisc noop state DOWN group default qlen <span class=m>1000</span>
</span></span><span class=line><span class=cl>    link/ether 5a:5d:f9:1e:b8:19 brd ff:ff:ff:ff:ff:ff
</span></span><span class=line><span class=cl>5: vmac1@eth0: &lt;BROADCAST,MULTICAST&gt; mtu <span class=m>1500</span> qdisc noop state DOWN group default qlen <span class=m>1000</span>
</span></span><span class=line><span class=cl>    link/ether 66:50:b5:23:d8:ce brd ff:ff:ff:ff:ff:ff
</span></span></code></pre></td></tr></table></div></div><p>然后需要获取到多个IP，直接执行 <code>dhclient</code> 即可</p><h3 id=进行联网认证>进行联网认证</h3><p>我们学校用的是深澜的认证系统，对其认证流程分析后，写了一个小工具:<a href=../../../posts/tutorials/campus-network-speed-overlay/sdu-srun.zip rel>多账号登录认证工具</a></p><div class="details admonition info open"><div class="details-summary admonition-title"><i class="icon icon-info-circled"></i>信息<i class="details-icon icon-angle-circled-right"></i></div><div class=details-content><div class=admonition-content><p>2021年11月4日 更新</p><p>用Rust写了一个新的登录工具，更轻量更好用</p><p><a href=https://github.com/zu1k/sdusrun target=_blank rel="noopener noreffer">https://github.com/zu1k/sdusrun</a></p></div></div></div><p>在启动前先修改配置文件，username为学号，password为上网认证的密码，ip分别写刚刚 macvlan 获取到的IP</p><p>学校限制的每个人最多5台设备同时在线，新登录的设备会把前面的设备顶下去，所以最好联合舍友用多个人的账号进行认证</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>login</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>201XXXXX1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>user1-password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>10.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>201XXXXX1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>user1-password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>10.0.0.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>201XXXXX2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>user2-password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>10.0.0.3</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon icon-pencil"></i>注意<i class="details-icon icon-angle-circled-right"></i></div><div class=details-content><div class=admonition-content>认证成功后即可进行下面的步骤，如果认证失败需要检查账号密码是否正确，本工具也不能保证后续系统更新后仍能使用，必要时可登录认证后台手工添加mac认证白名单</div></div></div><h3 id=进行路由级别的分流>进行路由级别的分流</h3><p>经过上面的步骤，其实现在已经有多个可以上网的接口了，每一个接口都限速30Mbps，可以通过修改路由表验证，但是测速发现还是总速度还是30Mbps，速度并没有叠加</p><p>这其实是因为你的主机只有一个默认网关，流量实际上只走了一条线，所以还是受单接口限速的限制。我们的目的是让流量能够分别走多个接口，从而达到速度叠加的效果，也就是常说的负载均衡</p><p>思路是：通过iptables规则给数据包打上标记，然后通过策略路由根据标记来选择走哪个接口出去。需要注意不同包之间的关系，追踪连接状态并恢复标记，否则的话同一个连接的不同包走了不同的接口，会被丢弃掉。</p><h4 id=创建路由表>创建路由表</h4><p>首先创建多个路由表，因为每一个路由表只能默认走一个接口，所以刚刚创建了多少虚拟网络接口，这里就要增加几个路由表，我按照2个接口来演示</p><p>编辑 <code>/etc/iproute2/rt_tables</code> 文件，在文件末尾增加两个路由表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 新增的路由表</span>
</span></span><span class=line><span class=cl><span class=m>100</span>      vmac0
</span></span><span class=line><span class=cl><span class=m>101</span>      vmac1
</span></span></code></pre></td></tr></table></div></div><p>保证新路由表中没有条目，先清空一下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ip route flush table vmac0
</span></span><span class=line><span class=cl>ip route flush table vmac1
</span></span></code></pre></td></tr></table></div></div><p>分别为两个路由表增加默认路由项，分别走不同的网络接口</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ip route add 0/0 dev vmac0 table vmac0
</span></span><span class=line><span class=cl>ip route add 0/0 dev vmac1 table vmac1
</span></span></code></pre></td></tr></table></div></div><h4 id=配置iptables>配置iptables</h4><p>分别创建多个新的链</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>iptables -t mangle -N VMAC0
</span></span><span class=line><span class=cl>iptables -t mangle -A VMAC0 -j MARK --set-mark 0x100
</span></span><span class=line><span class=cl>iptables -t mangle -A VMAC0 -j CONNMARK --save-mark
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>iptables -t mangle -N VMAC1
</span></span><span class=line><span class=cl>iptables -t mangle -A VMAC1 -j MARK --set-mark 0x101
</span></span><span class=line><span class=cl>iptables -t mangle -A VMAC1 -j CONNMARK --save-mark
</span></span></code></pre></td></tr></table></div></div><p>配置打标记的规则，每两个包（只看新建的连接）中第一个交给<code>VMAC0</code>处理，第二个交给<code>VMAC1</code>处理</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>iptables -t mangle -A OUTPUT -o vmac+ -m state --state NEW -m statistic --mode nth --every <span class=m>2</span> --packet <span class=m>0</span> -j VMAC0
</span></span><span class=line><span class=cl>iptables -t mangle -A OUTPUT -o vmac+ -m state --state NEW -m statistic --mode nth --every <span class=m>2</span> --packet <span class=m>1</span> -j VMAC1
</span></span><span class=line><span class=cl>iptables -t mangle -A OUTPUT -o vmac+ -m state --state ESTABLISHED,RELATED -j CONNMARK --restore-mark
</span></span></code></pre></td></tr></table></div></div><h4 id=配置策略路由>配置策略路由</h4><p>下面需要配置策略路由，根据我们设置的策略，流量分别由多个路由表进行路由，所以就可以走多个网络接口了</p><p>我们让防火墙标记为<code>0x100</code>的用<code>vmac0</code>路由表，标记为<code>0x101</code>流量的用<code>vmac1</code>路由表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ip rule add fwmark 0x100 table vmac0
</span></span><span class=line><span class=cl>ip rule add fwmark 0x101 table vmac1
</span></span></code></pre></td></tr></table></div></div><p>此时会出现一个问题，就是从外部发起的连接在进来后并没有打上防火墙标记，所以返回的包只能走默认的路由表。假如我们的默认路由表的默认路由是走<code>vmac0</code>，那来自<code>vmac1</code>的请求的响应包也会走<code>vmac0</code>出去，因为不属于同一个连接，这个包就会被丢掉。</p><p>我们的解决方法是再增加两条规则，来自哪个网卡的包的响应就从该网卡出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ip rule add from &lt;vmac0-ip&gt; table vmac0
</span></span><span class=line><span class=cl>ip rule add from &lt;vmac1-ip&gt; table vmac1
</span></span></code></pre></td></tr></table></div></div><h4 id=用作路由器>用作路由器</h4><p>如果这台linux需要用作网关，需要配置PREROUTING链，这里假设内网网段为 <code>192.168/16</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>iptables -t mangle -A PREROUTING -s 192.168/16 ! -d 192.168/16 -m state --state NEW -m statistic --mode nth --every <span class=m>2</span> --packet <span class=m>0</span> -j VMAC0
</span></span><span class=line><span class=cl>iptables -t mangle -A PREROUTING -s 192.168/16 ! -d 192.168/16 -m state --state NEW -m statistic --mode nth --every <span class=m>2</span> --packet <span class=m>1</span> -j VMAC1
</span></span><span class=line><span class=cl>iptables -t mangle -A PREROUTING -s 192.168/16 ! -d 192.168/16 -m state --state ESTABLISHED,RELATED -j CONNMARK --restore-mark
</span></span></code></pre></td></tr></table></div></div><p>同时需要对内网流量进行SNAT</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>iptables -t nat -A POSTROUTING -o vmac+ -j MASQUERADE
</span></span></code></pre></td></tr></table></div></div><p>经过上面的步骤，已经能够利用多个网络接口了。不过我们本质上是通过连接分流的，同一个连接的所有包会走同一个接口出去，所以如果你的程序是单线程网络，就看不到加速效果。可以通过speedtest多线程来进行测试，可以看到明显的网速叠加。</p><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon icon-pencil"></i>注意<i class="details-icon icon-angle-circled-right"></i></div><div class=details-content><div class=admonition-content><p>我刚刚的演示重启后虚拟网卡会丢失，因为自动分配的mac地址，重新运行命令会导致mac和ip变动，需要重新认证</p><p>可以使用指定mac地址的方法创建，也有持久化虚拟网卡的方法，可以一劳永逸</p><p>后面会将更加成熟的方法，这里手工配置不是重点，需要的自行学习研究吧！</p></div></div></div><h2 id=使用openwrtmwan3>使用OpenWrt+mwan3</h2><p>我比较推荐在宿舍里搞个软路由，普通的路由刷OpenWrt或者弄个树莓派刷OpenWrt都行，可以考虑买个二手矿渣 <code>newifi 3</code> 或者 <code>R2S</code></p><p>因为在OpenWrt里面有现成的插件，可以非常方便的创建多个虚拟网络接口，并能够利用图形界面配置更加强大的分流策略。</p><p>主要涉及到两个插件：kmod-macvlan和mwan3</p><h3 id=添加设备获取ip>添加设备，获取IP</h3><p>首先在正确配置好网络的基础上，先创建网络设备，类型是macvlan，在学习了Linux下手工操作的基础上，这里的配置项都好理解</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../../../posts/tutorials/campus-network-speed-overlay/openwrt/network-device.png alt=/posts/tutorials/campus-network-speed-overlay/openwrt/network-device.png title=网络设备></p><p>要几拨就添加几个设备，注意最好手工指定一下mac，基础设备选正常上网的wan口物理设备</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../../../posts/tutorials/campus-network-speed-overlay/openwrt/network-device-add.png alt=/posts/tutorials/campus-network-speed-overlay/openwrt/network-device-add.png title=添加网络设备></p><p>然后添加相同数量的接口，协议选DHCP，接口设备选刚刚创建的，一一对应</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../../../posts/tutorials/campus-network-speed-overlay/openwrt/network-interface-add.png alt=/posts/tutorials/campus-network-speed-overlay/openwrt/network-interface-add.png title=添加网络接口></p><p>接口添加好后，进行连接就会自动获取IP了，然后与上面手工方式一样，把所有IP都认证一下</p><h3 id=配置mwan3分流>配置mwan3分流</h3><p>在mwan的管理界面，首先添加接口，与网络里面刚刚配置的接口一一对应</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../../../posts/tutorials/campus-network-speed-overlay/openwrt/mwan-interface.png alt=/posts/tutorials/campus-network-speed-overlay/openwrt/mwan-interface.png title=添加接口></p><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon icon-pencil"></i>注意<i class="details-icon icon-angle-circled-right"></i></div><div class=details-content><div class=admonition-content>这里涉及到接口可用性的检测，需要仔细设置一下，后面的分流需要依赖这个可用性检测，总不能把流量分给不可用的接口吧</div></div></div><p>然后添加成员，与刚刚添加的接口一一对应，这里添加的可以在后面策略那里选择</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../../../posts/tutorials/campus-network-speed-overlay/openwrt/mwan-member.png alt=/posts/tutorials/campus-network-speed-overlay/openwrt/mwan-member.png title=添加成员></p><p>添加策略，图中第一条是负载均衡策略，刚刚添加的成员全都选中，意思就是说同时使用这所有的网络</p><p>后面几条策略分别是用来测试想用网络设备的</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../../../posts/tutorials/campus-network-speed-overlay/openwrt/mwan-policy.png alt=/posts/tutorials/campus-network-speed-overlay/openwrt/mwan-policy.png title=添加策略></p><p>最后添加分流规则，最简单的如图所示，目的地址不限，端口不限，协议不限，都走负载均衡策略，也就是从所有网口出</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../../../posts/tutorials/campus-network-speed-overlay/openwrt/mwan-rule.png alt=/posts/tutorials/campus-network-speed-overlay/openwrt/mwan-rule.png title=添加规则></p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../../../posts/tutorials/campus-network-speed-overlay/openwrt/mwan-rule-config.png alt=/posts/tutorials/campus-network-speed-overlay/openwrt/mwan-rule-config.png title=规则配置></p><p>在状态面板可以看到，多拨成功</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../../../posts/tutorials/campus-network-speed-overlay/openwrt/status.png alt=/posts/tutorials/campus-network-speed-overlay/openwrt/status.png title=多拨成功></p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon icon-lightbulb"></i>技巧<i class="details-icon icon-angle-circled-right"></i></div><div class=details-content><div class=admonition-content>mwan3代码在：<a href=https://github.com/openwrt/packages/tree/master/net/mwan3 target=_blank rel="noopener noreffer">https://github.com/openwrt/packages/tree/master/net/mwan3</a></div></div></div><h2 id=爱快分流很强大>爱快，分流很强大</h2><p>正好我在的实验室里有老旧的台式机，又有多个网卡，我就安装了以分流著称的iKuai系统</p><p>爱快路由系统对性能要求很高，64位甚至要求4G运存才能安装，不太建议宿舍用，不过实话实话这个是真的爽</p><p>首先在网路设置中，选择正确的物理网卡，接入方式选<code>基于物理网卡的混合模式</code>，在DHCP模式下添加多个虚拟网络接口，mac地址自己指定</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../../../posts/tutorials/campus-network-speed-overlay/ikuai/add-wan-if.png alt=/posts/tutorials/campus-network-speed-overlay/ikuai/add-wan-if.png title=添加网络接口></p><p>关开网络接口，让其DHCP获取到IP地址，然后按照之前说的方法进行网络认证</p><p>然后进入分流设置，配置多线负载</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../../../posts/tutorials/campus-network-speed-overlay/ikuai/load-balance.png alt=/posts/tutorials/campus-network-speed-overlay/ikuai/load-balance.png title=负载均衡></p><p>添加的时候有多种负载模式可供选择，可以添加多个负载规则。注意要把前面创建的网络接口全部开启</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../../../posts/tutorials/campus-network-speed-overlay/ikuai/add-load-balance.png alt=/posts/tutorials/campus-network-speed-overlay/ikuai/add-load-balance.png title=负载均衡></p><p>对！就是这么简单，iKuai就是牛，已经把网速叠加成功了</p><h2 id=新发现>新发现</h2><p>在与同学的交流中，发现校园网还可以用任意手机号验证码登录，登陆后的权限是访客，不过与学生权限一样，如此看来可以利用多个手机号突破5台设备的限制了</p><p>注意，登录成功后一定要修改密码，否则第二次登录的时候会提示创建新账号失败，是后台的BUG，日</p><p>最后，向大家推荐一个讲iptables的视频，可以在Youtube或者Bilibili搜索<code>坏人的iptables小讲堂</code>，讲的真的很不错</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-01-03&nbsp;<a class=git-hash href=https://github.com/zu1k/blog/commit/79e3544adc87a2b411847365d05a701aa88ae69e target=_blank title="commit by zu1k(i@zu1k.com) 79e3544adc87a2b411847365d05a701aa88ae69e: init">
<i class=icon-hashtag></i>79e3544</a></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=../../../posts/tutorials/campus-network-speed-overlay/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a title="分享到 Twitter" data-sharer=twitter data-url=https://zu1k.com/posts/tutorials/campus-network-speed-overlay/ data-title=垃圾校园网，我忍不了了 data-via=zu1k_ data-hashtags=Linux,多拨><i class=icon-twitter></i>
</a><a title="分享到 Tumblr" data-sharer=tumblr data-url=https://zu1k.com/posts/tutorials/campus-network-speed-overlay/ data-title=垃圾校园网，我忍不了了 data-caption=校园网被限速了，受不了垃圾网速，动手搞了单线多拨网速叠加 data-tags=Linux,多拨><i class=icon-tumblr></i>
</a><a title="分享到 Evernote" data-sharer=evernote data-url=https://zu1k.com/posts/tutorials/campus-network-speed-overlay/ data-title=垃圾校园网，我忍不了了><i class=icon-evernote></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class=icon-tags></i>&nbsp;<a href=../../../tags/linux/>Linux</a>,&nbsp;<a href=../../../tags/%E5%A4%9A%E6%8B%A8/>多拨</a></section><section><span><a onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=../../../>主页</a></span></section></div><div class=post-nav><a href=../../../posts/thinking/knowledge-refining/ class=prev rel=prev title=反对直接学习经过提炼的知识><i class=icon-angle-left></i>反对直接学习经过提炼的知识</a>
<a href=../../../posts/thinking/fuck-involution/ class=next rel=next title=干！有人在卷我>干！有人在卷我<i class=icon-angle-right></i></a></div></div><div id=comments><div class=giscus id=giscus></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/zh-CN>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class=icon-copyright></i><span itemprop=copyrightYear>2017 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://zu1k.com target=_blank>zu1k</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class=icon-up></i>
</a><a id=view-comments class=fixed-button title=查看评论><i class=icon-comment></i></a></div><link rel=stylesheet href=../../../lib/lightgallery/lightgallery.min.css><script type=text/javascript src=../../../lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=../../../lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=../../../lib/fuse/fuse.min.js></script><script type=text/javascript src=../../../lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=../../../lib/instant-page/5.1.0.min.js></script><script type=text/javascript src=../../../lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=../../../lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=../../../lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=../../../lib/clipboard/clipboard.min.js></script><script type=text/javascript src=../../../lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:100},comment:{giscus:{category:"Comments",categoryid:"DIC_kwDOEfJ9084CA02V",enable:!0,mapping:"og:title",repo:"zu1k/blog",repoid:"MDEwOlJlcG9zaXRvcnkzMDExMDQ1OTU="}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.1,type:"fuse",useExtendedSearch:!1}}</script><script type=text/javascript src=../../../js/theme.min.js></script></body></html>